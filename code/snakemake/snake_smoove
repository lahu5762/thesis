REF = "data/raw_data/reference/Canis_familiaris.CanFam3.1.dna.toplevel.fa",
EXCLUDE = "data/smoove/Canis_familiaris.Ngaps.bed",
GFF = "data/raw_data/reference/GCF_000002285.3_CanFam3.1_genomic.gff"

rule call:
    input:
        #bam="sorted_reads/{wolf}.bam"
        cram="data/raw_data/cram/{wolf}.cram"
    output:
        "out/smoove/results/called/{wolf}-smoove.genotyped.vcf.gz"
    log:
        "logs/call/{wolf}.log"
    singularity:
        "smoove_latest.sif"
    shell:
        #"smoove call --outdir smoove/results/ --exclude {EXCLUDE} â€“name {wildcards.wolf} --fasta {REF} -p 1 --genotype {input.bam}"
        "smoove call --outdir out/smoove/results/called/ --exclude {EXCLUDE} --name {wildcards.wolf} --fasta {REF} -p 8 --genotype {input.cram}"
rule merge:
    input:
        vcf=expand("out/smoove/results/called/{wolf}-smoove.genotyped.vcf.gz",
        wolf=WOLVES)
    output:
        "out/smoove/results/called/merged.sites.vcf.gz"
    log:
        "logs/merge/merged.sites.log"
    singularity:
        "smoove_latest.sif"
    shell:
        "smoove merge --name merged -f {REF} --outdir out/smoove/results/called/ {input.vcf}"
rule genotype:
    input:
        merge="out/smoove/results/called/merged.sites.vcf.gz",
        #bam="sorted_reads/{wolf}.bam"
        cram="data/raw_data/cram/{wolf}.cram"
    output:
        "out/smoove/results/genotyped/{wolf}.joint-smoove.genotyped.vcf.gz"
    log:
        "logs/genotype/{wolf}.log"
    singularity:
        "smoove_latest.sif"
    shell:
        #"smoove genotype -d -x -p 1 --name {wildcards.wolf}-joint â€“outdir smoove/results/genotyped/ --fasta {REF} --vcf {input.merge} {input.bam}"
        "smoove genotype -d -x -p 8 --name {wildcards.wolf}.joint --outdir out/smoove/results/genotyped/ --fasta {REF} --vcf {input.merge} {input.cram}"
rule paste:
    input:
        vcf=expand("out/smoove/results/genotyped/{wolf}.joint-smoove.genotyped.vcf.gz", 
        wolf=WOLVES)
    output:
        "cohort.smoove.square.vcf.gz"
    log:
        "logs/paste/cohort.log"
    singularity:
        "smoove_latest.sif"
    shell:
        "smoove paste --name cohort {input.vcf}"

rule annotate:
    input:
        "cohort.smoove.square.vcf.gz"
    output:
        "out/smoove/results/annotated/cohort.smoove.square.anno.vcf.gz"
    log:
        "logs/annotate/cohort.smoove.anno.log"
    singularity:
        "smoove_latest.sif"
    shell:
        "mkdir out/smoove/results/annotated; smoove annotate --gff {GFF} {input} | bgzip -c > {output}"